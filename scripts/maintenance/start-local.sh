#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ NeuroGrid –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
echo "=================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–Ω—ã –ª–∏ –ø–æ—Ä—Ç—ã
if lsof -i :3000 > /dev/null 2>&1; then
    echo "‚ùå –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É"
    exit 1
fi

if lsof -i :3001 > /dev/null 2>&1; then
    echo "‚ùå –ü–æ—Ä—Ç 3001 –∑–∞–Ω—è—Ç! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É"
    exit 1
fi

echo "‚úÖ –ü–æ—Ä—Ç—ã 3000 –∏ 3001 —Å–≤–æ–±–æ–¥–Ω—ã"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

echo ""
echo "üì° –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3001..."
cd coordinator-server
PORT=3001 node src/app-simple.js &
API_PID=$!

# –î–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if curl -s http://localhost:3001/health > /dev/null; then
    echo "‚úÖ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: http://localhost:3001"
else
    echo "‚ùå API —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    kill $API_PID 2>/dev/null
    exit 1
fi

echo ""
echo "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
cd ../web-interface
npm run dev &
WEB_PID=$!

# –î–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
sleep 5

echo ""
echo "üéâ NeuroGrid –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ!"
echo "================================"
echo "üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:3000"
echo "üì° API —Å–µ—Ä–≤–µ—Ä: http://localhost:3001"
echo "üß™ API —Ç–µ—Å—Ç—ã: http://localhost:3000/api-test"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    kill $API_PID 2>/dev/null
    kill $WEB_PID 2>/dev/null
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –õ–æ–≤–∏–º —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
trap cleanup SIGINT SIGTERM

# –ñ–¥–µ–º, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç
wait