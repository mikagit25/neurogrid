# Интеграция новых компонентов базы данных

## Обзор новых компонентов

Были созданы новые модульные компоненты для работы с базой данных PostgreSQL, которые заменят существующую систему хранения в памяти (AuthManager). Все новые компоненты спроектированы для работы параллельно с существующим кодом без его поломки.

### Созданные компоненты:

1. **Модели данных** (`src/models/`)
   - `User.js` - Управление пользователями с аутентификацией
   - `Transaction.js` - Финансовые операции и балансы
   - `Node.js` - Управление вычислительными узлами
   - `Job.js` - Управление задачами и очередями
   - `index.js` - Центральный экспорт моделей

2. **Сервисы** (`src/services/`)
   - `AuthService.js` - Новый сервис аутентификации

3. **Middleware** (`src/middleware/`)
   - `auth.js` - Middleware для аутентификации и авторизации

4. **API маршруты** (`src/routes/`)
   - `auth.js` - Новые маршруты для аутентификации

5. **Утилиты** (`src/utils/`)
   - `dbMigration.js` - Утилиты для миграции и тестирования

## Пошаговая интеграция

### Шаг 1: Проверка подключения к базе данных

```bash
# Проверяем подключение к PostgreSQL
node test-models.js connection
```

### Шаг 2: Тестирование новых моделей

```bash
# Запускаем полный тест всех компонентов
node test-models.js test
```

### Шаг 3: Обновление основного приложения

1. **Добавляем новые маршруты в main server файл:**

```javascript
// В основном server.js или app.js файле
const authRoutes = require('./src/routes/auth');

// Добавляем новые маршруты
app.use('/api/v2/auth', authRoutes);
```

2. **Постепенная замена AuthManager:**

```javascript
// Пример постепенной замены в существующих роутах
const authService = require('./src/services/AuthService');
const { authenticateToken } = require('./src/middleware/auth');

// Старый код:
// app.use('/api/dashboard', authMiddleware, dashboardRoutes);

// Новый код (работает параллельно):
app.use('/api/v2/dashboard', authenticateToken, dashboardRoutes);
```

### Шаг 4: Миграция данных пользователей

```bash
# Мигрируем существующих пользователей из AuthManager
node test-models.js migrate
```

### Шаг 5: Обновление существующих маршрутов

Постепенно заменяем использование AuthManager на новые модели:

```javascript
// Старый код
const user = authManager.users.get(email);

// Новый код
const user = await User.findByEmail(email);
```

## Структура API v2

Новые эндпоинты доступны по префиксу `/api/v2/`:

### Аутентификация
- `POST /api/v2/auth/register` - Регистрация пользователя
- `POST /api/v2/auth/login` - Вход в систему
- `POST /api/v2/auth/refresh` - Обновление токена
- `GET /api/v2/auth/me` - Информация о текущем пользователе
- `PUT /api/v2/auth/profile` - Обновление профиля
- `PUT /api/v2/auth/change-password` - Изменение пароля

### Управление пользователями (админка)
- `GET /api/v2/auth/users` - Список пользователей
- `GET /api/v2/auth/users/:id` - Информация о пользователе
- `DELETE /api/v2/auth/users/:id/deactivate` - Деактивация пользователя

## Конфигурация

Добавьте в `.env` файл:

```env
# JWT Configuration
JWT_SECRET=your-secret-key-here
JWT_EXPIRE=24h
REFRESH_TOKEN_EXPIRE=7d

# Database Configuration (если еще не настроено)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=neurogrid
DB_USER=your-username
DB_PASSWORD=your-password
```

## Преимущества новой системы

1. **Персистентность данных** - Все данные сохраняются в PostgreSQL
2. **Безопасность** - Пароли хэшируются с bcrypt
3. **JWT токены** - Современная аутентификация
4. **Масштабируемость** - Подготовлено для высоких нагрузок
5. **Модульность** - Легко расширяется и тестируется
6. **Обратная совместимость** - Работает рядом с существующим кодом

## Переходный период

1. **Фаза 1** (текущая): Новые компоненты работают параллельно
2. **Фаза 2**: Постепенная замена вызовов AuthManager на новые модели
3. **Фаза 3**: Полное удаление старой системы после проверки

## Тестирование

```bash
# Полный тест системы
node test-models.js test

# Очистка тестовых данных
node test-models.js cleanup

# Проверка только подключения
node test-models.js connection
```

## Логирование

Все новые компоненты используют структурированное логирование:

```javascript
logger.info('User authenticated', {
  userId: user.id,
  email: user.email,
  service: 'AuthService'
});
```

## Мониторинг

Новые модели предоставляют метрики для мониторинга:
- Количество активных пользователей
- Статистика транзакций
- Статус узлов
- Очередь задач

## Безопасность

1. **Хэширование паролей** с bcrypt
2. **JWT токены** с подписью
3. **Rate limiting** по пользователям
4. **Валидация входных данных**
5. **Логирование всех действий**
6. **Проверка прав доступа**

## Следующие шаги

1. Протестируйте новые компоненты в development окружении
2. Постепенно интегрируйте в существующие маршруты
3. Мигрируйте данные пользователей
4. Обновите фронтенд для использования новых API
5. Удалите старую систему после полной проверки