#!/usr/bin/env node\n\n/**\n * NeuroGrid Advanced Database Migration CLI\n * \n * Enhanced migration system with rollback support and better error handling.\n * \n * Usage:\n *   node src/utils/migrate-cli.js [command] [options]\n * \n * Commands:\n *   init      - Initialize migration system\n *   migrate   - Run pending migrations\n *   rollback  - Rollback migrations (--steps=N or --to=version)\n *   status    - Show migration status\n *   create    - Create new migration (--name=\"Migration Name\" [--type=js|sql])\n */\n\nconst { DatabaseMigrator } = require('../database/migrator');\nconst logger = require('../utils/logger');\n\nclass MigrationCLI {\n    constructor() {\n        this.migrator = new DatabaseMigrator();\n    }\n\n    async run() {\n        const args = process.argv.slice(2);\n        const command = args[0] || 'help';\n        const options = this.parseOptions(args.slice(1));\n\n        try {\n            await this.migrator.initialize();\n            \n            switch (command.toLowerCase()) {\n                case 'init':\n                    await this.initCommand();\n                    break;\n                \n                case 'migrate':\n                case 'up':\n                    await this.migrateCommand();\n                    break;\n                \n                case 'rollback':\n                case 'down':\n                    await this.rollbackCommand(options);\n                    break;\n                \n                case 'status':\n                    await this.statusCommand();\n                    break;\n                \n                case 'create':\n                    await this.createCommand(options);\n                    break;\n                \n                case 'help':\n                case '--help':\n                case '-h':\n                    this.showHelp();\n                    break;\n                \n                default:\n                    console.error(`Unknown command: ${command}`);\n                    this.showHelp();\n                    process.exit(1);\n            }\n            \n        } catch (error) {\n            logger.error('Migration CLI error', { error });\n            console.error('âŒ Migration failed:', error.message);\n            process.exit(1);\n        } finally {\n            await this.migrator.shutdown();\n        }\n    }\n\n    async initCommand() {\n        console.log('ðŸ—„ï¸ Initializing migration system...');\n        console.log('âœ… Migration system initialized successfully!');\n    }\n\n    async migrateCommand() {\n        console.log('ðŸš€ Running pending migrations...');\n        \n        const pendingMigrations = await this.migrator.getPendingMigrations();\n        \n        if (pendingMigrations.length === 0) {\n            console.log('âœ… No pending migrations found.');\n            return;\n        }\n\n        console.log(`ðŸ“‹ Found ${pendingMigrations.length} pending migrations:`);\n        pendingMigrations.forEach(m => {\n            console.log(`   - ${m.filename}`);\n        });\n        \n        console.log('');\n        \n        const result = await this.migrator.migrate();\n        \n        if (result.success) {\n            console.log(`âœ… Successfully applied ${result.appliedMigrations.length} migrations`);\n            result.appliedMigrations.forEach(m => {\n                console.log(`   âœ“ ${m.filename} (${m.executionTime}ms)`);\n            });\n        } else {\n            console.error('âŒ Migration failed');\n            process.exit(1);\n        }\n    }\n\n    async rollbackCommand(options) {\n        const { steps = 1, to } = options;\n        \n        console.log(`ðŸ”„ Rolling back migrations...`);\n        \n        if (to) {\n            console.log(`ðŸ“ Rolling back to version: ${to}`);\n        } else {\n            console.log(`ðŸ“ Rolling back ${steps} step(s)`);\n        }\n        \n        const result = await this.migrator.rollback({ steps, toVersion: to });\n        \n        if (result.success) {\n            console.log(`âœ… Successfully rolled back ${result.rolledBackMigrations.length} migrations`);\n            result.rolledBackMigrations.forEach(m => {\n                console.log(`   âœ“ ${m.filename}`);\n            });\n        } else {\n            console.error('âŒ Rollback failed');\n            process.exit(1);\n        }\n    }\n\n    async statusCommand() {\n        console.log('ðŸ“Š Migration Status');\n        console.log('==================\\n');\n        \n        const status = await this.migrator.getStatus();\n        \n        console.log(`Total migrations: ${status.total}`);\n        console.log(`Applied: ${status.appliedCount} âœ…`);\n        console.log(`Pending: ${status.pendingCount} â³`);\n        console.log(`Failed: ${status.failedCount} âŒ`);\n        \n        if (status.applied.length > 0) {\n            console.log('\\nðŸ“‹ Applied Migrations:');\n            status.applied.forEach(m => {\n                const statusIcon = m.success ? 'âœ…' : 'âŒ';\n                const executionTime = m.execution_time ? `(${m.execution_time}ms)` : '';\n                console.log(`   ${statusIcon} ${m.version} - ${m.filename} ${executionTime}`);\n                if (m.applied_at) {\n                    console.log(`      Applied at: ${new Date(m.applied_at).toISOString()}`);\n                }\n            });\n        }\n        \n        if (status.pending.length > 0) {\n            console.log('\\nâ³ Pending Migrations:');\n            status.pending.forEach(m => {\n                console.log(`   ðŸ“„ ${m.version} - ${m.filename}`);\n            });\n        }\n    }\n\n    async createCommand(options) {\n        const { name, type = 'sql' } = options;\n        \n        if (!name) {\n            console.error('âŒ Migration name is required. Use --name=\"Migration Name\"');\n            process.exit(1);\n        }\n        \n        if (!['sql', 'js'].includes(type)) {\n            console.error('âŒ Invalid migration type. Use --type=sql or --type=js');\n            process.exit(1);\n        }\n        \n        console.log(`ðŸ†• Creating new ${type.toUpperCase()} migration: ${name}`);\n        \n        const migration = await this.migrator.createMigration(name, type);\n        \n        console.log(`âœ… Migration created successfully:`);\n        console.log(`   ðŸ“„ File: ${migration.filename}`);\n        console.log(`   ðŸ“ Path: ${migration.path}`);\n        console.log(`   ðŸ“ Type: ${migration.type}`);\n        console.log('');\n        console.log(`ðŸ’¡ Edit the migration file and run 'node src/utils/migrate-cli.js migrate' to apply it.`);\n    }\n\n    parseOptions(args) {\n        const options = {};\n        \n        args.forEach(arg => {\n            if (arg.startsWith('--')) {\n                const [key, value] = arg.substring(2).split('=');\n                \n                if (value !== undefined) {\n                    // Handle quoted values\n                    options[key] = value.replace(/^[\"']|[\"']$/g, '');\n                } else {\n                    options[key] = true;\n                }\n            }\n        });\n        \n        return options;\n    }\n\n    showHelp() {\n        console.log(`\\nðŸ—„ï¸ NeuroGrid Database Migration CLI\\n`);\n        console.log('Usage: node src/utils/migrate-cli.js [command] [options]\\n');\n        console.log('Commands:');\n        console.log('  init                     Initialize migration system');\n        console.log('  migrate, up              Run pending migrations');\n        console.log('  rollback, down           Rollback migrations');\n        console.log('  status                   Show migration status');\n        console.log('  create                   Create new migration');\n        console.log('  help, --help, -h         Show this help\\n');\n        \n        console.log('Options:');\n        console.log('  --name=\"Name\"            Migration name (for create)');\n        console.log('  --type=sql|js            Migration type (for create, default: sql)');\n        console.log('  --steps=N                Number of steps to rollback (for rollback, default: 1)');\n        console.log('  --to=version             Rollback to specific version (for rollback)\\n');\n        \n        console.log('Examples:');\n        console.log('  node src/utils/migrate-cli.js migrate');\n        console.log('  node src/utils/migrate-cli.js rollback --steps=2');\n        console.log('  node src/utils/migrate-cli.js rollback --to=20241201120000');\n        console.log('  node src/utils/migrate-cli.js create --name=\"Add Users Table\" --type=sql');\n        console.log('  node src/utils/migrate-cli.js create --name=\"Data Migration\" --type=js');\n        console.log('');\n    }\n}\n\n// Run CLI if this file is executed directly\nif (require.main === module) {\n    const cli = new MigrationCLI();\n    cli.run().catch(error => {\n        console.error('Fatal error:', error);\n        process.exit(1);\n    });\n}\n\nmodule.exports = MigrationCLI;