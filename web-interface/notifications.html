<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - NeuroGrid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neurogrid': {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="index.html" class="flex items-center">
                            <div class="w-8 h-8 bg-neurogrid-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">NG</span>
                            </div>
                            <span class="ml-3 text-xl font-semibold text-gray-900">NeuroGrid</span>
                        </a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="index.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="analytics.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Analytics
                        </a>
                        <a href="#" class="border-neurogrid-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Notifications
                        </a>
                        <a href="support.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Support
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="markAllAsRead()" class="text-sm text-gray-500 hover:text-gray-700">
                        Mark all as read
                    </button>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Live Updates</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-white">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Notifications</h1>
                    <p class="mt-2 text-gray-600">Stay updated with your network activities</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full" id="unreadCount">
                        0 unread
                    </span>
                    <button onclick="refreshNotifications()" class="bg-neurogrid-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-neurogrid-700">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-6">
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Status:</label>
                    <select id="statusFilter" onchange="applyFilters()" class="text-sm border-gray-300 rounded-md">
                        <option value="all">All</option>
                        <option value="unread">Unread</option>
                        <option value="read">Read</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Type:</label>
                    <select id="typeFilter" onchange="applyFilters()" class="text-sm border-gray-300 rounded-md">
                        <option value="all">All Types</option>
                        <option value="success">Success</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="info">Info</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Priority:</label>
                    <select id="priorityFilter" onchange="applyFilters()" class="text-sm border-gray-300 rounded-md">
                        <option value="all">All</option>
                        <option value="urgent">Urgent</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>

                <button onclick="createTestNotification()" class="ml-auto text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-200">
                    Test Notification
                </button>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="bg-white rounded-lg shadow">
            <div class="divide-y divide-gray-200" id="notificationsList">
                <!-- Notifications will be loaded here -->
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-8">
                <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-neurogrid-500 transition ease-in-out duration-150">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading notifications...
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5m0-10h5l-5 5m-5-10v5m0 5v5"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No notifications</h3>
                <p class="mt-1 text-sm text-gray-500">You're all caught up! No new notifications to display.</p>
            </div>
        </div>

        <!-- Load More Button -->
        <div class="text-center mt-6">
            <button id="loadMoreBtn" onclick="loadMoreNotifications()" class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-50 hidden">
                Load More
            </button>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Notification Settings</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="settingsContent">
                    <!-- Settings will be loaded here -->
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeSettingsModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button onclick="saveSettings()" class="px-4 py-2 text-sm font-medium text-white bg-neurogrid-600 border border-transparent rounded-md hover:bg-neurogrid-700">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Button (Floating) -->
    <button onclick="openSettingsModal()" class="fixed bottom-6 right-6 bg-neurogrid-600 text-white p-3 rounded-full shadow-lg hover:bg-neurogrid-700 z-40">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
    </button>

    <!-- JavaScript -->
    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3001/api';
        let notifications = [];
        let currentPage = 0;
        let hasMore = true;
        let currentFilters = {
            status: 'all',
            type: 'all',
            priority: 'all'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            startAutoRefresh();
        });

        // Load notifications
        async function loadNotifications(append = false) {
            try {
                if (!append) {
                    document.getElementById('loadingState').style.display = 'block';
                    document.getElementById('emptyState').style.display = 'none';
                    currentPage = 0;
                }

                const params = new URLSearchParams({
                    limit: 20,
                    offset: currentPage * 20,
                    ...currentFilters
                });

                const response = await fetch(`${API_BASE_URL}/notifications?${params}`, {
                    headers: {
                        'x-user-id': 'default-user'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch notifications');
                }

                const result = await response.json();
                
                if (append) {
                    notifications = [...notifications, ...result.data.notifications];
                } else {
                    notifications = result.data.notifications;
                }

                hasMore = result.data.pagination.hasMore;
                updateUnreadCount(result.data.unreadCount);
                renderNotifications();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (notifications.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                }

                // Show/hide load more button
                document.getElementById('loadMoreBtn').style.display = hasMore ? 'inline-block' : 'none';

            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('loadingState').style.display = 'none';
                showError('Failed to load notifications');
            }
        }

        // Render notifications
        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = notifications.map(notification => {
                const typeColors = {
                    success: 'text-green-600 bg-green-100',
                    error: 'text-red-600 bg-red-100',
                    warning: 'text-yellow-600 bg-yellow-100',
                    info: 'text-blue-600 bg-blue-100'
                };

                const priorityColors = {
                    urgent: 'border-red-500',
                    high: 'border-orange-500',
                    medium: 'border-yellow-500',
                    low: 'border-gray-300'
                };

                const isUnread = notification.status === 'unread';
                
                return `
                    <div class="p-6 hover:bg-gray-50 ${isUnread ? 'bg-blue-50 border-l-4 ' + priorityColors[notification.priority] : ''}" 
                         id="notification-${notification.id}">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <span class="text-2xl">${notification.icon || getTypeIcon(notification.type)}</span>
                            </div>
                            <div class="ml-4 flex-1">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-sm font-medium text-gray-900 ${isUnread ? 'font-semibold' : ''}">
                                        ${notification.title}
                                    </h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${typeColors[notification.type] || 'text-gray-600 bg-gray-100'}">
                                            ${notification.type}
                                        </span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getPriorityColor(notification.priority)}">
                                            ${notification.priority}
                                        </span>
                                    </div>
                                </div>
                                <p class="mt-1 text-sm text-gray-600">
                                    ${notification.message}
                                </p>
                                <div class="mt-2 flex items-center justify-between">
                                    <span class="text-xs text-gray-500">
                                        ${notification.timeAgo || formatTimeAgo(notification.createdAt)}
                                    </span>
                                    <div class="flex items-center space-x-2">
                                        ${isUnread ? `
                                            <button onclick="markAsRead('${notification.id}')" 
                                                    class="text-xs text-blue-600 hover:text-blue-800">
                                                Mark as read
                                            </button>
                                        ` : ''}
                                        <button onclick="deleteNotification('${notification.id}')" 
                                                class="text-xs text-red-600 hover:text-red-800">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                ${notification.actions && notification.actions.length > 0 ? `
                                    <div class="mt-3 flex space-x-2">
                                        ${notification.actions.map(action => `
                                            <button onclick="handleNotificationAction('${notification.id}', '${action.type}')"
                                                    class="px-3 py-1 text-xs font-medium text-white bg-neurogrid-600 rounded hover:bg-neurogrid-700">
                                                ${action.label}
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper functions
        function getTypeIcon(type) {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            return icons[type] || 'ℹ️';
        }

        function getPriorityColor(priority) {
            const colors = {
                urgent: 'text-red-700 bg-red-100',
                high: 'text-orange-700 bg-orange-100',
                medium: 'text-yellow-700 bg-yellow-100',
                low: 'text-gray-700 bg-gray-100'
            };
            return colors[priority] || 'text-gray-700 bg-gray-100';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function updateUnreadCount(count) {
            document.getElementById('unreadCount').textContent = `${count} unread`;
        }

        // Actions
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}/read`, {
                    method: 'PATCH',
                    headers: {
                        'x-user-id': 'default-user'
                    }
                });

                if (response.ok) {
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.status = 'read';
                        renderNotifications();
                        // Update unread count
                        const currentCount = parseInt(document.getElementById('unreadCount').textContent);
                        updateUnreadCount(Math.max(0, currentCount - 1));
                    }
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllAsRead() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/read-all`, {
                    method: 'PATCH',
                    headers: {
                        'x-user-id': 'default-user'
                    }
                });

                if (response.ok) {
                    notifications.forEach(n => {
                        if (n.status === 'unread') {
                            n.status = 'read';
                        }
                    });
                    renderNotifications();
                    updateUnreadCount(0);
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        async function deleteNotification(notificationId) {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-id': 'default-user'
                    }
                });

                if (response.ok) {
                    notifications = notifications.filter(n => n.id !== notificationId);
                    renderNotifications();
                    
                    if (notifications.length === 0) {
                        document.getElementById('emptyState').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
            }
        }

        function applyFilters() {
            currentFilters = {
                status: document.getElementById('statusFilter').value,
                type: document.getElementById('typeFilter').value,
                priority: document.getElementById('priorityFilter').value
            };
            loadNotifications();
        }

        function loadMoreNotifications() {
            if (hasMore) {
                currentPage++;
                loadNotifications(true);
            }
        }

        function refreshNotifications() {
            loadNotifications();
        }

        async function createTestNotification() {
            try {
                const templates = ['task_completed', 'node_joined', 'payment_processed', 'system_alert'];
                const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
                
                const response = await fetch(`${API_BASE_URL}/notifications/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': 'default-user'
                    },
                    body: JSON.stringify({
                        templateId: randomTemplate
                    })
                });

                if (response.ok) {
                    refreshNotifications();
                }
            } catch (error) {
                console.error('Error creating test notification:', error);
            }
        }

        // Settings Modal
        async function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            await loadNotificationSettings();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        async function loadNotificationSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/settings`, {
                    headers: {
                        'x-user-id': 'default-user'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    renderSettingsForm(result.data);
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function renderSettingsForm(settings) {
            const content = document.getElementById('settingsContent');
            const channels = ['email', 'web', 'sms', 'push'];
            
            content.innerHTML = channels.map(channel => {
                const channelSettings = settings[channel] || {};
                return `
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-medium text-gray-900 capitalize">${channel}</h4>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" ${channelSettings.enabled ? 'checked' : ''} 
                                       class="sr-only peer" id="enable-${channel}">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notification Types:</label>
                                <div class="space-y-1">
                                    ${['task_completed', 'task_failed', 'payment_processed', 'system_alert', 'support_ticket_update'].map(type => `
                                        <label class="flex items-center">
                                            <input type="checkbox" ${(channelSettings.types || []).includes(type) || (channelSettings.types || []).includes('all') ? 'checked' : ''}
                                                   class="mr-2" name="${channel}-types" value="${type}">
                                            <span class="text-sm text-gray-600">${type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Frequency:</label>
                                <select class="text-sm border-gray-300 rounded-md w-full" id="frequency-${channel}">
                                    <option value="immediate" ${channelSettings.frequency === 'immediate' ? 'selected' : ''}>Immediate</option>
                                    <option value="hourly" ${channelSettings.frequency === 'hourly' ? 'selected' : ''}>Hourly</option>
                                    <option value="daily" ${channelSettings.frequency === 'daily' ? 'selected' : ''}>Daily</option>
                                    <option value="weekly" ${channelSettings.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveSettings() {
            try {
                const settings = {};
                const channels = ['email', 'web', 'sms', 'push'];
                
                channels.forEach(channel => {
                    const enabled = document.getElementById(`enable-${channel}`).checked;
                    const frequency = document.getElementById(`frequency-${channel}`).value;
                    const typeCheckboxes = document.querySelectorAll(`input[name="${channel}-types"]:checked`);
                    const types = Array.from(typeCheckboxes).map(cb => cb.value);
                    
                    settings[channel] = {
                        enabled,
                        types: types.length > 0 ? types : ['all'],
                        frequency
                    };
                });

                const response = await fetch(`${API_BASE_URL}/notifications/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': 'default-user'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    closeSettingsModal();
                    showSuccess('Settings saved successfully');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showError('Failed to save settings');
            }
        }

        // Auto refresh
        function startAutoRefresh() {
            setInterval(() => {
                refreshNotifications();
            }, 30000); // Refresh every 30 seconds
        }

        // Utility functions
        function showSuccess(message) {
            // Simple success toast (you can enhance this)
            console.log('Success:', message);
        }

        function showError(message) {
            // Simple error toast (you can enhance this)
            console.error('Error:', message);
        }

        function handleNotificationAction(notificationId, actionType) {
            console.log(`Handling action ${actionType} for notification ${notificationId}`);
            // Implement specific action handlers here
        }
    </script>
</body>
</html>