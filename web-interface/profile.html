<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroGrid - Профиль пользователя</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neurogrid': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .profile-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
        }
        .rating-stars {
            display: inline-flex;
            align-items: center;
        }
        .star {
            color: #fbbf24;
            font-size: 1.2rem;
        }
        .star.empty {
            color: #d1d5db;
        }
        .achievement-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="index.html" class="flex items-center">
                            <div class="w-8 h-8 bg-neurogrid-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">NG</span>
                            </div>
                            <span class="ml-3 text-xl font-semibold text-gray-900">NeuroGrid</span>
                        </a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="dashboard.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <i class="fas fa-tachometer-alt mr-2"></i>
                            Дашборд
                        </a>
                        <a href="#" class="border-neurogrid-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <i class="fas fa-user-circle mr-2"></i>
                            Профиль
                        </a>
                        <a href="wallet.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <i class="fas fa-wallet mr-2"></i>
                            Кошелек
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <button onclick="window.location.href='dashboard.html'" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left mr-2"></i>Назад к дашборду
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Profile Header -->
        <div class="profile-header rounded-xl p-8 text-white mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mr-6">
                        <i class="fas fa-user text-4xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold" id="profileName">Пользователь</h1>
                        <p class="text-white/80 mb-2" id="profileEmail">email@example.com</p>
                        <div class="flex items-center space-x-4">
                            <div class="rating-stars" id="userRating">
                                <!-- Stars will be generated here -->
                            </div>
                            <span class="bg-white/20 px-3 py-1 rounded-full text-sm" id="userLevel">Новичок</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="profileBalance">0.00 NGRID</div>
                    <div class="text-white/80 text-sm">Текущий баланс</div>
                    <div class="mt-2">
                        <span class="bg-green-500 px-3 py-1 rounded-full text-sm" id="accountStatus">Активен</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tabs -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchTab('overview')" id="overviewTab" class="profile-tab border-b-2 border-neurogrid-500 text-neurogrid-600 py-3 px-1 text-sm font-medium">
                        <i class="fas fa-chart-bar mr-2"></i>Обзор
                    </button>
                    <button onclick="switchTab('activity')" id="activityTab" class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium">
                        <i class="fas fa-history mr-2"></i>Активность
                    </button>
                    <button onclick="switchTab('achievements')" id="achievementsTab" class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium">
                        <i class="fas fa-trophy mr-2"></i>Достижения
                    </button>
                    <button onclick="switchTab('settings')" id="settingsTab" class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium">
                        <i class="fas fa-cog mr-2"></i>Настройки
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Overview Tab -->
            <div id="overviewContent" class="tab-content">
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Statistics -->
                    <div class="xl:col-span-2 space-y-6">
                        <!-- Performance Stats -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-6">Статистика производительности</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-neurogrid-600" id="tasksCompleted">0</div>
                                    <div class="text-sm text-gray-600">Задач выполнено</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600" id="successRate">0%</div>
                                    <div class="text-sm text-gray-600">Успешность</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="totalEarned">0</div>
                                    <div class="text-sm text-gray-600">Заработано NGRID</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="uptime">0h</div>
                                    <div class="text-sm text-gray-600">Время работы</div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Активность за последние 30 дней</h3>
                            <div class="chart-container">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Последняя активность</h3>
                            <div id="recentActivity" class="space-y-3">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="space-y-6">
                        <!-- Level Progress -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Прогресс уровня</h3>
                            <div class="text-center mb-4">
                                <div class="text-3xl font-bold text-neurogrid-600" id="currentLevel">1</div>
                                <div class="text-sm text-gray-600">Уровень</div>
                            </div>
                            <div class="progress-bar mb-2">
                                <div class="progress-fill" id="levelProgress" style="width: 45%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="currentXP">450 XP</span>
                                <span id="nextLevelXP">1000 XP</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">До следующего уровня: <span id="xpToNext">550 XP</span></p>
                        </div>

                        <!-- Node Status (for operators) -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6" id="nodeStatusCard">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Статус узла</h3>
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-gray-600">Статус:</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800" id="nodeStatus">
                                    Не подключен
                                </span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Время работы:</span>
                                    <span id="nodeUptime">0h</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Задач выполнено:</span>
                                    <span id="nodeTasksCompleted">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Рейтинг узла:</span>
                                    <span id="nodeRating">0.0 ⭐</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Быстрые действия</h3>
                            <div class="space-y-3">
                                <button onclick="window.location.href='wallet.html'" class="w-full bg-neurogrid-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-neurogrid-700 transition-colors">
                                    <i class="fas fa-wallet mr-2"></i>Управление кошельком
                                </button>
                                <button onclick="window.location.href='node-setup.html'" class="w-full border border-neurogrid-600 text-neurogrid-600 py-2 px-4 rounded-lg font-medium hover:bg-neurogrid-50 transition-colors">
                                    <i class="fas fa-server mr-2"></i>Настроить узел
                                </button>
                                <button onclick="showSupportModal()" class="w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-headset mr-2"></i>Поддержка
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Tab -->
            <div id="activityContent" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">История активности</h3>
                        <div class="flex space-x-2">
                            <select id="activityFilter" class="text-sm border border-gray-300 rounded-md px-3 py-1">
                                <option value="all">Все действия</option>
                                <option value="tasks">Задачи</option>
                                <option value="payments">Платежи</option>
                                <option value="nodes">Узлы</option>
                            </select>
                            <button onclick="refreshActivity()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="activityList">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Tab -->
            <div id="achievementsContent" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Achievement cards will be loaded here -->
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsContent" class="tab-content hidden">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <!-- Account Settings -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Настройки аккаунта</h3>
                        <form id="accountSettingsForm" onsubmit="updateAccountSettings(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="settingsEmail" class="w-full border border-gray-300 rounded-lg px-4 py-3" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Отображаемое имя</label>
                                    <input type="text" id="displayName" class="w-full border border-gray-300 rounded-lg px-4 py-3" placeholder="Ваше имя">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Часовой пояс</label>
                                    <select id="timezone" class="w-full border border-gray-300 rounded-lg px-4 py-3">
                                        <option value="Europe/Moscow">Москва (UTC+3)</option>
                                        <option value="Europe/Kiev">Киев (UTC+2)</option>
                                        <option value="UTC">UTC (UTC+0)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-6">
                                <button type="submit" class="bg-neurogrid-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-neurogrid-700 transition-colors">
                                    Сохранить изменения
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Notification Settings -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Уведомления</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">Email уведомления</h4>
                                    <p class="text-sm text-gray-600">Получать уведомления на email</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" id="emailNotifications" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-neurogrid-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-neurogrid-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">Уведомления о задачах</h4>
                                    <p class="text-sm text-gray-600">Получать уведомления о статусе задач</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" id="taskNotifications" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-neurogrid-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-neurogrid-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">Уведомления о платежах</h4>
                                    <p class="text-sm text-gray-600">Получать уведомления о транзакциях</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" id="paymentNotifications" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-neurogrid-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-neurogrid-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Безопасность</h3>
                        <div class="space-y-4">
                            <button onclick="showChangePasswordModal()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                                <i class="fas fa-key mr-2"></i>Изменить пароль
                            </button>
                            <button onclick="show2FAModal()" class="w-full border border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-shield-alt mr-2"></i>Двухфакторная аутентификация
                            </button>
                            <button onclick="showSessionsModal()" class="w-full border border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-laptop mr-2"></i>Активные сессии
                            </button>
                        </div>
                    </div>

                    <!-- API Settings -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">API доступ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API ключ</label>
                                <div class="flex">
                                    <input type="password" id="apiKey" class="flex-1 border border-gray-300 rounded-l-lg px-4 py-3" value="sk-1234567890abcdef" readonly>
                                    <button onclick="toggleApiKey()" class="bg-gray-200 border border-l-0 border-gray-300 rounded-r-lg px-4 py-3 hover:bg-gray-300 transition-colors">
                                        <i class="fas fa-eye" id="apiKeyToggle"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="regenerateApiKey()" class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-yellow-700 transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Пересоздать
                                </button>
                                <button onclick="copyApiKey()" class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-copy mr-2"></i>Копировать
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 z-50 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Изменить пароль</h3>
                <button onclick="closeModal('changePasswordModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="changePasswordForm" onsubmit="changePassword(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Текущий пароль</label>
                            <input type="password" id="currentPassword" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Новый пароль</label>
                            <input type="password" id="newPassword" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Подтвердите новый пароль</label>
                            <input type="password" id="confirmPassword" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button type="button" onclick="closeModal('changePasswordModal')" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                            Отмена
                        </button>
                        <button type="submit" class="flex-1 bg-neurogrid-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-neurogrid-700 transition-colors">
                            Изменить пароль
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let currentUser = null;
        let activityChart = null;
        let currentTab = 'overview';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeProfile();
        });

        // Initialize profile page
        async function initializeProfile() {
            try {
                // Check authentication
                const token = localStorage.getItem('authToken');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }

                // Load user profile
                await loadUserProfile();
                
                // Load profile data
                await loadProfileData();

                // Initialize activity chart
                initializeActivityChart();

            } catch (error) {
                console.error('Profile initialization error:', error);
                showNotification('Ошибка инициализации профиля', 'error');
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.data;
                    updateProfileHeader();
                } else {
                    throw new Error('Failed to load user profile');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                showNotification('Ошибка загрузки профиля', 'error');
            }
        }

        // Update profile header
        function updateProfileHeader() {
            if (!currentUser) return;

            document.getElementById('profileName').textContent = currentUser.displayName || currentUser.email || 'Пользователь';
            document.getElementById('profileEmail').textContent = currentUser.email || '';
            document.getElementById('settingsEmail').value = currentUser.email || '';
            document.getElementById('displayName').value = currentUser.displayName || '';

            // Generate user rating stars
            generateRatingStars(currentUser.rating || 0);
            
            // Set user level
            const level = calculateUserLevel(currentUser.xp || 0);
            document.getElementById('userLevel').textContent = getLevelName(level);
        }

        // Generate rating stars
        function generateRatingStars(rating) {
            const container = document.getElementById('userRating');
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating - fullStars >= 0.5;
            
            container.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const star = document.createElement('i');
                if (i < fullStars) {
                    star.className = 'fas fa-star star';
                } else if (i === fullStars && hasHalfStar) {
                    star.className = 'fas fa-star-half-alt star';
                } else {
                    star.className = 'far fa-star star empty';
                }
                container.appendChild(star);
            }

            // Add rating text
            const ratingText = document.createElement('span');
            ratingText.className = 'ml-2 text-white/80 text-sm';
            ratingText.textContent = `(${rating.toFixed(1)})`;
            container.appendChild(ratingText);
        }

        // Calculate user level
        function calculateUserLevel(xp) {
            return Math.floor(xp / 1000) + 1;
        }

        // Get level name
        function getLevelName(level) {
            const levels = ['Новичок', 'Исследователь', 'Эксперт', 'Мастер', 'Гуру'];
            return levels[Math.min(level - 1, levels.length - 1)];
        }

        // Load profile data
        async function loadProfileData() {
            try {
                // Load balance
                const balanceResponse = await fetch(`/api/tokens/balance/${currentUser.id}`);
                if (balanceResponse.ok) {
                    const balanceData = await balanceResponse.json();
                    document.getElementById('profileBalance').textContent = `${balanceData.balance.toFixed(2)} NGRID`;
                    document.getElementById('totalEarned').textContent = balanceData.totalEarned.toFixed(0);
                    
                    // Update level progress
                    updateLevelProgress(currentUser.xp || 450);
                }

                // Load statistics (mock data)
                loadStatistics();
                
                // Load recent activity
                loadRecentActivity();

                // Load achievements
                loadAchievements();

            } catch (error) {
                console.error('Error loading profile data:', error);
                showNotification('Ошибка загрузки данных профиля', 'error');
            }
        }

        // Update level progress
        function updateLevelProgress(xp) {
            const currentLevel = calculateUserLevel(xp);
            const xpForCurrentLevel = (currentLevel - 1) * 1000;
            const xpInCurrentLevel = xp - xpForCurrentLevel;
            const xpForNextLevel = 1000;
            const progressPercent = (xpInCurrentLevel / xpForNextLevel) * 100;

            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentXP').textContent = `${xpInCurrentLevel} XP`;
            document.getElementById('nextLevelXP').textContent = `${xpForNextLevel} XP`;
            document.getElementById('xpToNext').textContent = `${xpForNextLevel - xpInCurrentLevel} XP`;
            document.getElementById('levelProgress').style.width = `${progressPercent}%`;
        }

        // Load statistics (mock data)
        function loadStatistics() {
            // Mock statistics
            const stats = {
                tasksCompleted: 24,
                successRate: 96,
                uptime: 168, // hours
                nodeTasksCompleted: 12,
                nodeRating: 4.8,
                nodeUptime: 72
            };

            document.getElementById('tasksCompleted').textContent = stats.tasksCompleted;
            document.getElementById('successRate').textContent = `${stats.successRate}%`;
            document.getElementById('uptime').textContent = `${stats.uptime}h`;
            
            // Node stats
            document.getElementById('nodeTasksCompleted').textContent = stats.nodeTasksCompleted;
            document.getElementById('nodeRating').textContent = `${stats.nodeRating} ⭐`;
            document.getElementById('nodeUptime').textContent = `${stats.nodeUptime}h`;

            // Update node status
            if (stats.nodeTasksCompleted > 0) {
                document.getElementById('nodeStatus').textContent = 'Активен';
                document.getElementById('nodeStatus').className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            }
        }

        // Load recent activity
        function loadRecentActivity() {
            const activities = [
                { type: 'task', description: 'Выполнена задача GPT-4', time: '2 часа назад', icon: 'fa-brain', color: 'blue' },
                { type: 'payment', description: 'Получено 5.75 NGRID за выполнение задачи', time: '4 часа назад', icon: 'fa-coins', color: 'green' },
                { type: 'node', description: 'Узел подключен к сети', time: '1 день назад', icon: 'fa-server', color: 'purple' },
                { type: 'achievement', description: 'Получено достижение "Первые шаги"', time: '2 дня назад', icon: 'fa-trophy', color: 'yellow' }
            ];

            const container = document.getElementById('recentActivity');
            container.innerHTML = activities.map(activity => {
                const colorClasses = {
                    blue: 'bg-blue-100 text-blue-600',
                    green: 'bg-green-100 text-green-600',
                    purple: 'bg-purple-100 text-purple-600',
                    yellow: 'bg-yellow-100 text-yellow-600'
                };

                return `
                    <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="w-10 h-10 ${colorClasses[activity.color]} rounded-full flex items-center justify-center mr-3">
                            <i class="fas ${activity.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${activity.description}</p>
                            <p class="text-xs text-gray-500">${activity.time}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load achievements
        function loadAchievements() {
            const achievements = [
                { id: 'first_task', name: 'Первые шаги', description: 'Выполните первую задачу', icon: 'fa-baby', earned: true },
                { id: 'task_master', name: 'Мастер задач', description: 'Выполните 10 задач', icon: 'fa-tasks', earned: true },
                { id: 'node_operator', name: 'Оператор узла', description: 'Настройте свой первый узел', icon: 'fa-server', earned: true },
                { id: 'high_rating', name: 'Высокий рейтинг', description: 'Достигните рейтинга 4.5', icon: 'fa-star', earned: false },
                { id: 'big_earner', name: 'Большой заработок', description: 'Заработайте 1000 NGRID', icon: 'fa-money-bill-wave', earned: false },
                { id: 'community_hero', name: 'Герой сообщества', description: 'Помогите 5 пользователям', icon: 'fa-hands-helping', earned: false }
            ];

            const container = document.getElementById('achievementsContent');
            container.innerHTML = achievements.map(achievement => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 ${achievement.earned ? '' : 'opacity-60'}">
                    <div class="flex items-center mb-4">
                        <div class="achievement-badge mr-4">
                            <i class="fas ${achievement.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${achievement.name}</h3>
                            <p class="text-sm text-gray-600">${achievement.description}</p>
                        </div>
                        <div>
                            ${achievement.earned ? 
                                '<i class="fas fa-check-circle text-green-500 text-2xl"></i>' : 
                                '<i class="fas fa-lock text-gray-400 text-2xl"></i>'
                            }
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${achievement.earned ? 'Получено' : 'Заблокировано'}
                    </div>
                </div>
            `).join('');
        }

        // Initialize activity chart
        function initializeActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 30}, (_, i) => {
                        const date = new Date();
                        date.setDate(date.getDate() - (29 - i));
                        return date.getDate();
                    }),
                    datasets: [{
                        label: 'Выполненные задачи',
                        data: [0, 1, 0, 2, 1, 0, 3, 2, 1, 0, 4, 2, 1, 3, 0, 1, 2, 0, 1, 1, 3, 2, 0, 1, 2, 1, 0, 2, 1, 3],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Заработано NGRID',
                        data: [0, 2.5, 0, 5.0, 2.5, 0, 7.5, 5.0, 2.5, 0, 10.0, 5.0, 2.5, 7.5, 0, 2.5, 5.0, 0, 2.5, 2.5, 7.5, 5.0, 0, 2.5, 5.0, 2.5, 0, 5.0, 2.5, 7.5],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(btn => {
                btn.className = 'profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium';
            });
            document.getElementById(tab + 'Tab').className = 'profile-tab border-b-2 border-neurogrid-500 text-neurogrid-600 py-3 px-1 text-sm font-medium';

            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected content
            document.getElementById(tab + 'Content').classList.remove('hidden');
            currentTab = tab;

            // Load tab-specific data
            if (tab === 'activity') {
                loadActivityHistory();
            }
        }

        // Load activity history
        function loadActivityHistory() {
            const activities = [
                { type: 'task', description: 'Выполнена задача GPT-4: "Анализ рынка криптовалют"', time: '23 октября 2025, 14:30', status: 'completed' },
                { type: 'payment', description: 'Получено 5.75 NGRID за выполнение задачи', time: '23 октября 2025, 14:32', status: 'completed' },
                { type: 'task', description: 'Выполнена задача DALL-E 3: "Генерация логотипа"', time: '23 октября 2025, 12:15', status: 'completed' },
                { type: 'payment', description: 'Списано 2.50 NGRID за задачу', time: '23 октября 2025, 12:10', status: 'completed' },
                { type: 'node', description: 'Узел подключен к сети NeuroGrid', time: '22 октября 2025, 18:45', status: 'completed' },
                { type: 'achievement', description: 'Получено достижение "Мастер задач"', time: '22 октября 2025, 16:20', status: 'completed' }
            ];

            const container = document.getElementById('activityList');
            container.innerHTML = activities.map(activity => {
                const typeIcons = {
                    task: { icon: 'fa-brain', color: 'blue' },
                    payment: { icon: 'fa-coins', color: 'green' },
                    node: { icon: 'fa-server', color: 'purple' },
                    achievement: { icon: 'fa-trophy', color: 'yellow' }
                };

                const colorClasses = {
                    blue: 'bg-blue-100 text-blue-600',
                    green: 'bg-green-100 text-green-600',
                    purple: 'bg-purple-100 text-purple-600',
                    yellow: 'bg-yellow-100 text-yellow-600'
                };

                return `
                    <div class="flex items-start p-4 border border-gray-200 rounded-lg mb-3 hover:bg-gray-50">
                        <div class="w-10 h-10 ${colorClasses[typeIcons[activity.type].color]} rounded-full flex items-center justify-center mr-4 mt-1">
                            <i class="fas ${typeIcons[activity.type].icon}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${activity.description}</p>
                            <p class="text-sm text-gray-500 mt-1">${activity.time}</p>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Завершено
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Form handlers
        function updateAccountSettings(event) {
            event.preventDefault();
            showNotification('Настройки аккаунта обновлены', 'success');
        }

        function changePassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showNotification('Пароли не совпадают', 'error');
                return;
            }

            showNotification('Пароль успешно изменен', 'success');
            closeModal('changePasswordModal');
            document.getElementById('changePasswordForm').reset();
        }

        // API functions
        function toggleApiKey() {
            const input = document.getElementById('apiKey');
            const icon = document.getElementById('apiKeyToggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function regenerateApiKey() {
            const newKey = 'sk-' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            document.getElementById('apiKey').value = newKey;
            showNotification('API ключ пересоздан', 'success');
        }

        function copyApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            navigator.clipboard.writeText(apiKey).then(() => {
                showNotification('API ключ скопирован в буфер обмена', 'success');
            });
        }

        // Utility functions
        function refreshActivity() {
            loadActivityHistory();
            showNotification('Активность обновлена', 'success');
        }

        function showSupportModal() {
            showNotification('Функция поддержки в разработке', 'info');
        }

        function show2FAModal() {
            showNotification('Функция 2FA в разработке', 'info');
        }

        function showSessionsModal() {
            showNotification('Функция управления сессиями в разработке', 'info');
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const typeClasses = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            notification.className = `${typeClasses[type]} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>