<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroGrid - Личный кабинет</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/web-interface/js/payment-service.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neurogrid': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .gradient-bg { background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); }
        .glass-effect { 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        .node-status-active { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="index.html" class="flex items-center">
                            <div class="w-8 h-8 bg-neurogrid-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">NG</span>
                            </div>
                            <span class="ml-3 text-xl font-semibold text-gray-900">NeuroGrid</span>
                        </a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="#" class="border-neurogrid-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <i class="fas fa-tachometer-alt mr-2"></i>
                            Дашборд
                        </a>
                        <a href="node-monitoring.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <i class="fas fa-server mr-2"></i>
                            Узлы
                        </a>
                        <a href="analytics.html" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Аналитика
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- User Menu -->
                    <div class="relative">
                        <button id="userMenuButton" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-neurogrid-500">
                            <div class="w-8 h-8 bg-neurogrid-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-neurogrid-600"></i>
                            </div>
                            <span class="ml-2 text-gray-700 font-medium" id="userName">Пользователь</span>
                            <i class="fas fa-chevron-down ml-2 text-gray-400"></i>
                        </button>
                        <div id="userMenu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <a href="#" onclick="showProfileModal()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-user-circle mr-2"></i>Профиль
                                </a>
                                <a href="#" onclick="showWalletModal()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-wallet mr-2"></i>Кошелек
                                </a>
                                <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- User Type Selector -->
        <div class="mb-8">
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg w-fit">
                <button id="clientModeBtn" onclick="switchMode('client')" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 bg-white text-neurogrid-600 shadow-sm">
                    <i class="fas fa-user mr-2"></i>Заказчик задач
                </button>
                <button id="nodeModeBtn" onclick="switchMode('node')" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900">
                    <i class="fas fa-server mr-2"></i>Оператор узла
                </button>
            </div>
        </div>

        <!-- Client Mode Dashboard -->
        <div id="clientDashboard" class="fade-in">
            <!-- Balance and Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="balance-card rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Баланс токенов</p>
                            <p class="text-2xl font-bold" id="clientBalance">0.00 NGRID</p>
                        </div>
                        <div class="w-12 h-12 bg-neurogrid-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-coins text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <i class="fas fa-arrow-up text-green-400 mr-1"></i>
                        <span class="text-green-400">+12.5%</span>
                        <span class="text-gray-300 ml-2">за месяц</span>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Активные задачи</p>
                            <p class="text-2xl font-bold text-gray-900" id="activeTasks">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-tasks text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Завершенные</p>
                            <p class="text-2xl font-bold text-gray-900" id="completedTasks">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Потрачено</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalSpent">0 NGRID</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-credit-card text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Tasks and Quick Actions -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <!-- Recent Tasks -->
                <div class="xl:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Последние задачи</h3>
                            <button onclick="showNewTaskModal()" class="bg-neurogrid-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-neurogrid-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Новая задача
                            </button>
                        </div>
                        <div class="p-6">
                            <div id="clientTasksList" class="space-y-4">
                                <!-- Tasks will be loaded here -->
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-tasks text-4xl mb-4"></i>
                                    <p>Задачи не найдены</p>
                                    <p class="text-sm">Создайте первую задачу для начала работы</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-6">
                    <!-- Wallet Management -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Управление балансом</h3>
                        <div class="space-y-3">
                            <button onclick="showDepositModal()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus-circle mr-2"></i>Пополнить баланс
                            </button>
                            <button onclick="showWithdrawModal()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                                <i class="fas fa-minus-circle mr-2"></i>Вывести средства
                            </button>
                            <button onclick="showTransactionHistory()" class="w-full border border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-history mr-2"></i>История транзакций
                            </button>
                        </div>
                    </div>

                    <!-- Account Stats -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Статистика аккаунта</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Аккаунт создан:</span>
                                <span class="font-medium" id="accountCreated">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Всего задач:</span>
                                <span class="font-medium" id="totalTasksCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Успешность:</span>
                                <span class="font-medium text-green-600" id="successRate">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Node Operator Mode Dashboard -->
        <div id="nodeDashboard" class="hidden">
            <!-- Node Status and Earnings -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="balance-card rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Заработано токенов</p>
                            <p class="text-2xl font-bold" id="nodeEarnings">0.00 NGRID</p>
                        </div>
                        <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <i class="fas fa-arrow-up text-green-400 mr-1"></i>
                        <span class="text-green-400">+8.2%</span>
                        <span class="text-gray-300 ml-2">за неделю</span>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Статус узла</p>
                            <p class="text-lg font-bold" id="nodeStatus">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    Не подключен
                                </span>
                            </p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center" id="nodeStatusIcon">
                            <i class="fas fa-server text-gray-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Выполнено задач</p>
                            <p class="text-2xl font-bold text-gray-900" id="nodeCompletedTasks">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Рейтинг</p>
                            <p class="text-2xl font-bold text-gray-900" id="nodeRating">0.0</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-star text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Node Performance and Management -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <!-- Node Performance Chart -->
                <div class="xl:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">Производительность узла</h3>
                        </div>
                        <div class="p-6">
                            <canvas id="nodePerformanceChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Node Management -->
                <div class="space-y-6">
                    <!-- Node Actions -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Управление узлом</h3>
                        <div class="space-y-3">
                            <button onclick="showNodeSetup()" class="w-full bg-neurogrid-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-neurogrid-700 transition-colors">
                                <i class="fas fa-cog mr-2"></i>Настроить узел
                            </button>
                            <button onclick="toggleNode()" id="nodeToggleBtn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                <i class="fas fa-play mr-2"></i>Запустить узел
                            </button>
                            <button onclick="showNodeLogs()" class="w-full border border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-file-alt mr-2"></i>Логи узла
                            </button>
                        </div>
                    </div>

                    <!-- Earnings Management -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Управление доходами</h3>
                        <div class="space-y-3">
                            <button onclick="showWithdrawModal()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                <i class="fas fa-money-bill-wave mr-2"></i>Вывести доходы
                            </button>
                            <button onclick="showEarningsHistory()" class="w-full border border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                <i class="fas fa-chart-line mr-2"></i>История доходов
                            </button>
                        </div>
                    </div>

                    <!-- Node Statistics -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Статистика узла</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Время работы:</span>
                                <span class="font-medium" id="nodeUptime">0h</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Загрузка CPU:</span>
                                <span class="font-medium" id="nodeCpuUsage">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Использование GPU:</span>
                                <span class="font-medium" id="nodeGpuUsage">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Средний доход/час:</span>
                                <span class="font-medium text-green-600" id="avgEarningsPerHour">0 NGRID</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-50 modal-backdrop">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Профиль пользователя</h3>
                        <button onclick="closeModal('profileModal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="profileEmail" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ID пользователя</label>
                            <input type="text" id="profileUserId" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Дата регистрации</label>
                            <input type="text" id="profileCreatedAt" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50" readonly>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="closeModal('profileModal')" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:ml-3 sm:w-auto">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div id="walletModal" class="hidden fixed inset-0 z-50 modal-backdrop">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Управление кошельком</h3>
                        <button onclick="closeModal('walletModal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Wallet Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="switchWalletTab('balance')" id="balanceTab" class="wallet-tab border-b-2 border-neurogrid-500 text-neurogrid-600 py-2 px-1 text-sm font-medium">
                                Баланс
                            </button>
                            <button onclick="switchWalletTab('deposit')" id="depositTab" class="wallet-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                                Пополнение
                            </button>
                            <button onclick="switchWalletTab('withdraw')" id="withdrawTab" class="wallet-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                                Вывод
                            </button>
                            <button onclick="switchWalletTab('history')" id="historyTab" class="wallet-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                                История
                            </button>
                        </nav>
                    </div>

                    <!-- Wallet Content -->
                    <div id="walletContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let currentMode = 'client';
        let currentUser = null;
        let performanceChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadUserData();
            
            // Setup user menu toggle
            document.getElementById('userMenuButton').addEventListener('click', function() {
                const menu = document.getElementById('userMenu');
                menu.classList.toggle('hidden');
            });

            // Close user menu when clicking outside
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('userMenu');
                const button = document.getElementById('userMenuButton');
                if (!button.contains(event.target) && !menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        });

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Check authentication
                const token = localStorage.getItem('authToken');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }

                // Load dashboard data
                await loadUserProfile();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showNotification('Ошибка инициализации дашборда', 'error');
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.data;
                    document.getElementById('userName').textContent = currentUser.email || 'Пользователь';
                } else {
                    throw new Error('Failed to load user profile');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            if (currentMode === 'client') {
                await loadClientData();
            } else {
                await loadNodeData();
            }
        }

        // Load client dashboard data
        async function loadClientData() {
            try {
                // Load token balance
                const balanceResponse = await fetch(`/api/tokens/balance/${currentUser.id}`);
                if (balanceResponse.ok) {
                    const balanceData = await balanceResponse.json();
                    document.getElementById('clientBalance').textContent = `${balanceData.balance.toFixed(2)} NGRID`;
                    document.getElementById('totalSpent').textContent = `${balanceData.totalSpent.toFixed(2)} NGRID`;
                    document.getElementById('accountCreated').textContent = new Date(balanceData.createdAt).toLocaleDateString('ru-RU');
                }

                // Load tasks data (mock data for now)
                loadClientTasks();

            } catch (error) {
                console.error('Error loading client data:', error);
                showNotification('Ошибка загрузки данных', 'error');
            }
        }

        // Load node dashboard data
        async function loadNodeData() {
            try {
                // Load node statistics
                const nodeResponse = await fetch(`/api/nodes/stats/${currentUser.id}`);
                if (nodeResponse.ok) {
                    const nodeData = await nodeResponse.json();
                    updateNodeStats(nodeData);
                }

                // Load earnings data
                const earningsResponse = await fetch(`/api/tokens/balance/${currentUser.id}`);
                if (earningsResponse.ok) {
                    const earningsData = await earningsResponse.json();
                    document.getElementById('nodeEarnings').textContent = `${earningsData.totalEarned.toFixed(2)} NGRID`;
                }

                // Initialize performance chart
                initializePerformanceChart();

            } catch (error) {
                console.error('Error loading node data:', error);
                showNotification('Ошибка загрузки данных узла', 'error');
            }
        }

        // Switch between client and node mode
        function switchMode(mode) {
            currentMode = mode;
            
            // Update buttons
            const clientBtn = document.getElementById('clientModeBtn');
            const nodeBtn = document.getElementById('nodeModeBtn');
            
            if (mode === 'client') {
                clientBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 bg-white text-neurogrid-600 shadow-sm';
                nodeBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900';
                
                document.getElementById('clientDashboard').classList.remove('hidden');
                document.getElementById('nodeDashboard').classList.add('hidden');
                
                loadClientData();
            } else {
                nodeBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 bg-white text-neurogrid-600 shadow-sm';
                clientBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900';
                
                document.getElementById('nodeDashboard').classList.remove('hidden');
                document.getElementById('clientDashboard').classList.add('hidden');
                
                loadNodeData();
            }
        }

        // Load client tasks (mock data)
        function loadClientTasks() {
            const tasksContainer = document.getElementById('clientTasksList');
            
            // Mock tasks data
            const mockTasks = [
                { id: 1, model: 'GPT-4', status: 'completed', prompt: 'Analyze market data...', cost: 2.5, createdAt: new Date(Date.now() - 3600000) },
                { id: 2, model: 'DALL-E 3', status: 'processing', prompt: 'Generate image of...', cost: 1.8, createdAt: new Date(Date.now() - 1800000) },
                { id: 3, model: 'Claude 3', status: 'queued', prompt: 'Write a summary...', cost: 1.2, createdAt: new Date() }
            ];

            if (mockTasks.length === 0) {
                return;
            }

            let activeTasks = 0;
            let completedTasks = 0;

            tasksContainer.innerHTML = mockTasks.map(task => {
                if (task.status === 'processing' || task.status === 'queued') activeTasks++;
                if (task.status === 'completed') completedTasks++;

                const statusClass = {
                    'completed': 'bg-green-100 text-green-800',
                    'processing': 'bg-blue-100 text-blue-800',
                    'queued': 'bg-yellow-100 text-yellow-800',
                    'failed': 'bg-red-100 text-red-800'
                };

                const statusText = {
                    'completed': 'Завершена',
                    'processing': 'Выполняется',
                    'queued': 'В очереди',
                    'failed': 'Ошибка'
                };

                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-gray-900">${task.model}</h4>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass[task.status]}">
                                    ${statusText[task.status]}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${task.prompt}</p>
                            <div class="flex items-center text-xs text-gray-500">
                                <span>Стоимость: ${task.cost} NGRID</span>
                                <span class="mx-2">•</span>
                                <span>${task.createdAt.toLocaleString('ru-RU')}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <button class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Update stats
            document.getElementById('activeTasks').textContent = activeTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('totalTasksCount').textContent = mockTasks.length;
            document.getElementById('successRate').textContent = completedTasks > 0 ? Math.round((completedTasks / mockTasks.length) * 100) + '%' : '0%';
        }

        // Update node statistics
        function updateNodeStats(nodeData) {
            // Mock node data if not provided
            if (!nodeData) {
                nodeData = {
                    status: 'offline',
                    completedTasks: 0,
                    rating: 0.0,
                    uptime: 0,
                    cpuUsage: 0,
                    gpuUsage: 0,
                    avgEarningsPerHour: 0
                };
            }

            const statusElement = document.getElementById('nodeStatus');
            const statusIcon = document.getElementById('nodeStatusIcon');
            
            if (nodeData.status === 'active') {
                statusElement.innerHTML = `
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 node-status-active">
                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></span>
                        Активен
                    </span>
                `;
                statusIcon.innerHTML = '<i class="fas fa-server text-green-600 text-xl"></i>';
                statusIcon.className = 'w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center';
            } else {
                statusElement.innerHTML = `
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Не подключен
                    </span>
                `;
            }

            document.getElementById('nodeCompletedTasks').textContent = nodeData.completedTasks;
            document.getElementById('nodeRating').textContent = nodeData.rating.toFixed(1);
            document.getElementById('nodeUptime').textContent = Math.floor(nodeData.uptime / 3600) + 'h';
            document.getElementById('nodeCpuUsage').textContent = Math.round(nodeData.cpuUsage) + '%';
            document.getElementById('nodeGpuUsage').textContent = Math.round(nodeData.gpuUsage) + '%';
            document.getElementById('avgEarningsPerHour').textContent = nodeData.avgEarningsPerHour.toFixed(2) + ' NGRID';
        }

        // Initialize performance chart
        function initializePerformanceChart() {
            const ctx = document.getElementById('nodePerformanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1h', '2h', '3h', '4h', '5h', '6h'],
                    datasets: [{
                        label: 'Задач/час',
                        data: [0, 2, 1, 4, 3, 5],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Доходность/час',
                        data: [0, 1.2, 0.8, 2.4, 1.8, 3.1],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Modal functions
        function showProfileModal() {
            if (currentUser) {
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profileUserId').value = currentUser.id || '';
                document.getElementById('profileCreatedAt').value = currentUser.createdAt ? new Date(currentUser.createdAt).toLocaleDateString('ru-RU') : '';
            }
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function showWalletModal() {
            document.getElementById('walletModal').classList.remove('hidden');
            switchWalletTab('balance');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Wallet modal functions
        function switchWalletTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.wallet-tab').forEach(btn => {
                btn.className = 'wallet-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium';
            });
            document.getElementById(tab + 'Tab').className = 'wallet-tab border-b-2 border-neurogrid-500 text-neurogrid-600 py-2 px-1 text-sm font-medium';

            // Load content
            const content = document.getElementById('walletContent');
            switch(tab) {
                case 'balance':
                    loadWalletBalance(content);
                    break;
                case 'deposit':
                    loadDepositForm(content);
                    break;
                case 'withdraw':
                    loadWithdrawForm(content);
                    break;
                case 'history':
                    loadTransactionHistory(content);
                    break;
            }
        }

        function loadWalletBalance(container) {
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-3">Текущий баланс</h4>
                        <div class="text-3xl font-bold text-neurogrid-600" id="modalBalance">Загрузка...</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="modalEarned">0</div>
                            <div class="text-sm text-gray-600">Заработано</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" id="modalSpent">0</div>
                            <div class="text-sm text-gray-600">Потрачено</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load actual balance
            loadModalBalance();
        }

        async function loadModalBalance() {
            try {
                const response = await fetch(`/api/tokens/balance/${currentUser.id}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('modalBalance').textContent = `${data.balance.toFixed(2)} NGRID`;
                    document.getElementById('modalEarned').textContent = data.totalEarned.toFixed(2);
                    document.getElementById('modalSpent').textContent = data.totalSpent.toFixed(2);
                }
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        function loadDepositForm(container) {
            container.innerHTML = `
                <form class="space-y-4" onsubmit="handleDeposit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Сумма пополнения</label>
                            <input type="number" name="amount" min="10" step="0.01" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="100.00" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Валюта</label>
                            <select name="currency" class="w-full border border-gray-300 rounded-md px-3 py-2" onchange="updateDepositPreview()">
                                <option value="USD">USD - Доллар США</option>
                                <option value="EUR">EUR - Евро</option>
                                <option value="RUB">RUB - Российский рубль</option>
                                <option value="GBP">GBP - Британский фунт</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                        <div class="flex justify-between items-center text-sm">
                            <span>Получите NEURO токенов: <span id="neuroAmount" class="font-bold">~0</span></span>
                            <span>Комиссия: <span id="feeAmount" class="font-bold">~0</span></span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Способ оплаты</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="card" class="sr-only" checked onchange="updatePaymentMethodUI()">
                                <div class="text-center">
                                    <i class="fas fa-credit-card text-2xl text-blue-600 mb-2"></i>
                                    <div class="font-medium">Банковская карта</div>
                                    <div class="text-xs text-gray-500">Visa, MasterCard</div>
                                </div>
                            </label>
                            <label class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="paypal" class="sr-only" onchange="updatePaymentMethodUI()">
                                <div class="text-center">
                                    <i class="fab fa-paypal text-2xl text-yellow-600 mb-2"></i>
                                    <div class="font-medium">PayPal</div>
                                    <div class="text-xs text-gray-500">Электронный кошелек</div>
                                </div>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <label class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="crypto" class="sr-only" onchange="updatePaymentMethodUI()">
                                <div class="text-center">
                                    <i class="fab fa-bitcoin text-2xl text-orange-500 mb-2"></i>
                                    <div class="font-medium">Криптовалюта</div>
                                    <div class="text-xs text-gray-500">BTC, ETH, USDT</div>
                                </div>
                            </label>
                            <label class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="bank" class="sr-only" onchange="updatePaymentMethodUI()">
                                <div class="text-center">
                                    <i class="fas fa-university text-2xl text-green-600 mb-2"></i>
                                    <div class="font-medium">Банковский перевод</div>
                                    <div class="text-xs text-gray-500">Для крупных сумм</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Card input section (Stripe Elements) -->
                    <div id="cardInputSection" class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">Данные карты</label>
                        <div id="card-element" class="p-3 border border-gray-300 rounded-md bg-white">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <div id="card-errors" class="text-red-600 text-sm hidden"></div>
                    </div>
                    
                    <!-- Crypto input section -->
                    <div id="cryptoInputSection" class="space-y-3 hidden">
                        <label class="block text-sm font-medium text-gray-700">Криптовалюта</label>
                        <select name="cryptoCurrency" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="USDT">Tether (USDT)</option>
                            <option value="USDC">USD Coin (USDC)</option>
                        </select>
                    </div>
                    
                    <button type="submit" id="depositSubmitBtn" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-plus-circle mr-2"></i>Пополнить баланс
                    </button>
                    
                    <div class="text-xs text-gray-500 text-center">
                        256-битное SSL шифрование • PCI DSS сертифицировано • Безопасные платежи
                    </div>
                </form>
            `;
            
            // Initialize payment method UI
            updatePaymentMethodUI();
            updateDepositPreview();
            
            // Initialize Stripe Elements if card is selected
            if (window.paymentService) {
                setTimeout(() => {
                    initializeStripeElements();
                }, 100);
            }
        }

        function loadWithdrawForm(container) {
            container.innerHTML = `
                <form class="space-y-4" onsubmit="handleWithdraw(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Сумма вывода (NEURO)</label>
                            <input type="number" name="tokenAmount" min="10" step="0.01" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="100.00" required onchange="updateWithdrawPreview()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Валюта вывода</label>
                            <select name="currency" class="w-full border border-gray-300 rounded-md px-3 py-2" onchange="updateWithdrawPreview()">
                                <option value="USD">USD - Доллар США</option>
                                <option value="EUR">EUR - Евро</option>
                                <option value="RUB">RUB - Российский рубль</option>
                                <option value="GBP">GBP - Британский фунт</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 border border-orange-200 rounded-md p-3">
                        <div class="flex justify-between items-center text-sm">
                            <span>Вы получите: <span id="withdrawFiatAmount" class="font-bold">~0</span></span>
                            <span>Комиссия (2%): <span id="withdrawFeeAmount" class="font-bold">~0</span></span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Способ вывода</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <label class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="withdrawalMethod" value="paypal" class="sr-only" checked onchange="updateWithdrawMethodUI()">
                                <div class="text-center">
                                    <i class="fab fa-paypal text-2xl text-blue-600 mb-2"></i>
                                    <div class="font-medium">PayPal</div>
                                    <div class="text-xs text-gray-500">1-2 рабочих дня</div>
                                </div>
                            </label>
                            <label class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="withdrawalMethod" value="bank" class="sr-only" onchange="updateWithdrawMethodUI()">
                                <div class="text-center">
                                    <i class="fas fa-university text-2xl text-green-600 mb-2"></i>
                                    <div class="font-medium">Банковский счет</div>
                                    <div class="text-xs text-gray-500">3-5 рабочих дней</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- PayPal destination -->
                    <div id="paypalDestination" class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">Email PayPal</label>
                        <input type="email" name="destination" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="your@email.com" required>
                    </div>
                    
                    <!-- Bank destination -->
                    <div id="bankDestination" class="space-y-3 hidden">
                        <label class="block text-sm font-medium text-gray-700">Банковские реквизиты</label>
                        <textarea name="destination" class="w-full border border-gray-300 rounded-md px-3 py-2 h-24" placeholder="Укажите полные банковские реквизиты:&#10;Банк: &#10;БИК: &#10;Номер счета: &#10;ФИО получателя: " required></textarea>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                        <div class="flex">
                            <i class="fas fa-exclamation-triangle text-yellow-400 mr-2 mt-0.5"></i>
                            <div class="text-sm text-yellow-800">
                                <div class="font-medium mb-1">Важная информация:</div>
                                <ul class="list-disc list-inside space-y-1 text-xs">
                                    <li>Минимальная сумма вывода: 10 NEURO</li>
                                    <li>Комиссия составляет 2% от суммы</li>
                                    <li>Обработка может занять от 1 до 5 рабочих дней</li>
                                    <li>Проверьте правильность реквизитов</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 transition-colors font-medium">
                        <i class="fas fa-minus-circle mr-2"></i>Вывести средства
                    </button>
                    
                    <div class="text-xs text-gray-500 text-center">
                        Все выводы проходят проверку безопасности и соответствуют требованиям AML/KYC
                    </div>
                </form>
            `;
            
            updateWithdrawMethodUI();
            updateWithdrawPreview();
        }

        function loadTransactionHistory(container) {
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between py-3 border-b border-gray-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-plus text-green-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-medium">Пополнение баланса</div>
                                <div class="text-sm text-gray-500">23 октября 2025, 14:30</div>
                            </div>
                        </div>
                        <div class="text-green-600 font-medium">+100.00 NGRID</div>
                    </div>
                    <div class="flex items-center justify-between py-3 border-b border-gray-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-brain text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-medium">Оплата задачи GPT-4</div>
                                <div class="text-sm text-gray-500">23 октября 2025, 12:15</div>
                            </div>
                        </div>
                        <div class="text-red-600 font-medium">-2.50 NGRID</div>
                    </div>
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p>Больше транзакций нет</p>
                    </div>
                </div>
            `;
        }

        // Payment handlers
        async function handleDeposit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const depositData = {
                amount: parseFloat(formData.get('amount')),
                currency: formData.get('currency'),
                paymentMethod: formData.get('paymentMethod'),
                returnUrl: window.location.origin + '/dashboard.html'
            };

            try {
                showNotification('Создание платежа...', 'info');
                
                const paymentIntent = await paymentService.createDeposit(depositData);
                
                if (depositData.paymentMethod === 'card') {
                    await processCardPayment(paymentIntent);
                } else if (depositData.paymentMethod === 'crypto') {
                    showCryptoPayment(paymentIntent);
                } else {
                    showNotification('Перенаправление на ' + depositData.paymentMethod + '...', 'info');
                    if (depositData.paymentMethod === 'paypal') {
                        await paymentService.initiatePayPalPayment(paymentIntent);
                    }
                }
            } catch (error) {
                showNotification('Ошибка создания платежа: ' + error.message, 'error');
            }
        }

        async function handleWithdraw(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Get destination based on withdrawal method
            const withdrawalMethod = formData.get('withdrawalMethod');
            const destinationValue = formData.get('destination');
            
            let destination = {};
            if (withdrawalMethod === 'paypal') {
                destination.email = destinationValue;
            } else if (withdrawalMethod === 'bank') {
                destination.bankAccount = destinationValue;
            }
            
            const withdrawalData = {
                tokenAmount: parseFloat(formData.get('tokenAmount')),
                currency: formData.get('currency'),
                withdrawalMethod: withdrawalMethod,
                destination: destination
            };

            try {
                showNotification('Создание запроса на вывод...', 'info');
                
                const withdrawalRequest = await paymentService.createWithdrawal(withdrawalData);
                
                showNotification('Запрос на вывод создан! ID: ' + withdrawalRequest.id, 'success');
                closeModal('walletModal');
                loadModalBalance(); // Refresh balance
            } catch (error) {
                showNotification('Ошибка вывода: ' + error.message, 'error');
            }
        }

        // Other functions
        function showNewTaskModal() {
            showNotification('Функция создания задач в разработке', 'info');
        }

        function showNodeSetup() {
            window.location.href = 'node-setup.html';
        }

        function toggleNode() {
            showNotification('Функция управления узлом в разработке', 'info');
        }

        function showNodeLogs() {
            showNotification('Функция просмотра логов в разработке', 'info');
        }

        function showDepositModal() {
            showWalletModal();
            switchWalletTab('deposit');
        }

        function showWithdrawModal() {
            showWalletModal();
            switchWalletTab('withdraw');
        }

        function showTransactionHistory() {
            showWalletModal();
            switchWalletTab('history');
        }

        function showEarningsHistory() {
            showTransactionHistory();
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const typeClasses = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            notification.className = `${typeClasses[type]} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Initialize payment service
        let paymentService;
        let stripeElements = null;

        // Payment method UI functions
        function updatePaymentMethodUI() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            const cardSection = document.getElementById('cardInputSection');
            const cryptoSection = document.getElementById('cryptoInputSection');
            
            if (cardSection && cryptoSection) {
                if (selectedMethod === 'card') {
                    cardSection.classList.remove('hidden');
                    cryptoSection.classList.add('hidden');
                } else if (selectedMethod === 'crypto') {
                    cardSection.classList.add('hidden');
                    cryptoSection.classList.remove('hidden');
                } else {
                    cardSection.classList.add('hidden');
                    cryptoSection.classList.add('hidden');
                }
            }
            
            // Update selected visual state
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                const label = radio.closest('label');
                if (radio.checked) {
                    label.classList.add('border-blue-500', 'bg-blue-50');
                    label.classList.remove('border-gray-200');
                } else {
                    label.classList.remove('border-blue-500', 'bg-blue-50');
                    label.classList.add('border-gray-200');
                }
            });
        }

        function updateDepositPreview() {
            if (!paymentService) return;
            
            const amountInput = document.querySelector('input[name="amount"]');
            const currencySelect = document.querySelector('select[name="currency"]');
            const paymentMethodRadio = document.querySelector('input[name="paymentMethod"]:checked');
            
            if (amountInput && currencySelect && paymentMethodRadio) {
                const amount = parseFloat(amountInput.value) || 0;
                const currency = currencySelect.value;
                const paymentMethod = paymentMethodRadio.value;
                
                const neuroAmount = paymentService.convertToNeuro(amount, currency);
                const fees = paymentService.calculateFees(amount, currency, paymentMethod);
                
                const neuroAmountEl = document.getElementById('neuroAmount');
                const feeAmountEl = document.getElementById('feeAmount');
                
                if (neuroAmountEl) {
                    neuroAmountEl.textContent = neuroAmount.toFixed(4);
                }
                if (feeAmountEl) {
                    feeAmountEl.textContent = paymentService.formatAmount(fees.total, currency);
                }
            }
        }

        function initializeStripeElements() {
            const cardElement = document.getElementById('card-element');
            if (!cardElement || !window.Stripe) return;
            
            // Initialize Stripe with test key (should be from environment)
            const publishableKey = 'pk_test_51234567890abcdef'; // This should come from backend
            
            try {
                stripeElements = paymentService.initStripeElements('#card-element', publishableKey);
                
                if (stripeElements && stripeElements.cardElement) {
                    stripeElements.cardElement.on('change', (event) => {
                        const errorElement = document.getElementById('card-errors');
                        if (event.error) {
                            errorElement.textContent = event.error.message;
                            errorElement.classList.remove('hidden');
                        } else {
                            errorElement.textContent = '';
                            errorElement.classList.add('hidden');
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to initialize Stripe Elements:', error);
                const cardSection = document.getElementById('cardInputSection');
                if (cardSection) {
                    cardSection.innerHTML = '<div class="text-red-600 text-sm">Stripe не загружен. Попробуйте другой способ оплаты.</div>';
                }
            }
        }

        async function processCardPayment(paymentIntent) {
            if (!stripeElements || !stripeElements.cardElement) {
                throw new Error('Stripe не инициализирован');
            }
            
            try {
                showNotification('Обработка платежа...', 'info');
                const result = await paymentService.processStripePayment(paymentIntent, stripeElements.cardElement);
                
                if (result.status === 'succeeded') {
                    showNotification('Платеж успешно выполнен!', 'success');
                    closeModal('walletModal');
                    loadModalBalance(); // Refresh balance
                } else {
                    throw new Error('Платеж не завершен');
                }
            } catch (error) {
                console.error('Card payment failed:', error);
                throw error;
            }
        }

        function showCryptoPayment(paymentIntent) {
            const cryptoInfo = paymentService.displayCryptoPayment(paymentIntent);
            
            // Close the wallet modal and show crypto payment modal
            closeModal('walletModal');
            
            // Create and show crypto payment modal
            const modalHtml = `
                <div id="cryptoPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl max-w-md w-full mx-4 max-h-screen overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Криптоплатеж ${cryptoInfo.currency}</h3>
                                <button onclick="closeModal('cryptoPaymentModal')" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-center">
                                    <div class="bg-gray-100 p-4 rounded-lg">
                                        <img src="${cryptoInfo.qrCode}" alt="QR Code" class="w-32 h-32 mx-auto mb-2">
                                        <div class="text-sm text-gray-600">Сканируйте QR-код</div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Адрес для перевода:</label>
                                    <div class="flex items-center">
                                        <input type="text" value="${cryptoInfo.address}" class="flex-1 p-2 border border-gray-300 rounded-l-md bg-gray-50" readonly>
                                        <button onclick="copyToClipboard('${cryptoInfo.address}')" class="px-3 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Сумма к переводу:</label>
                                    <div class="flex items-center">
                                        <input type="text" value="${cryptoInfo.amount}" class="flex-1 p-2 border border-gray-300 rounded-l-md bg-gray-50" readonly>
                                        <button onclick="copyToClipboard('${cryptoInfo.amount}')" class="px-3 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                    <div class="text-sm text-yellow-800">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Требуется ${cryptoInfo.confirmations} подтверждения сети. 
                                        Средства будут зачислены автоматически после получения подтверждений.
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                    <div class="text-sm text-blue-800">
                                        <i class="fas fa-clock mr-2"></i>
                                        Ожидание платежа... Статус обновляется автоматически.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Скопировано в буфер обмена!', 'success');
            }).catch(() => {
                showNotification('Не удалось скопировать', 'error');
            });
        }

        function updateWithdrawPreview() {
            if (!paymentService) return;
            
            const tokenAmountInput = document.querySelector('input[name="tokenAmount"]');
            const currencySelect = document.querySelector('select[name="currency"]');
            
            if (tokenAmountInput && currencySelect) {
                const tokenAmount = parseFloat(tokenAmountInput.value) || 0;
                const currency = currencySelect.value;
                
                const fiatAmount = paymentService.convertFromNeuro(tokenAmount, currency);
                const fee = fiatAmount * 0.02; // 2% fee
                const netAmount = fiatAmount - fee;
                
                const withdrawFiatAmountEl = document.getElementById('withdrawFiatAmount');
                const withdrawFeeAmountEl = document.getElementById('withdrawFeeAmount');
                
                if (withdrawFiatAmountEl) {
                    withdrawFiatAmountEl.textContent = paymentService.formatAmount(netAmount, currency);
                }
                if (withdrawFeeAmountEl) {
                    withdrawFeeAmountEl.textContent = paymentService.formatAmount(fee, currency);
                }
            }
        }

        function updateWithdrawMethodUI() {
            const selectedMethod = document.querySelector('input[name="withdrawalMethod"]:checked')?.value;
            const paypalDestination = document.getElementById('paypalDestination');
            const bankDestination = document.getElementById('bankDestination');
            
            if (paypalDestination && bankDestination) {
                if (selectedMethod === 'paypal') {
                    paypalDestination.classList.remove('hidden');
                    bankDestination.classList.add('hidden');
                    paypalDestination.querySelector('input').required = true;
                    bankDestination.querySelector('textarea').required = false;
                } else if (selectedMethod === 'bank') {
                    paypalDestination.classList.add('hidden');
                    bankDestination.classList.remove('hidden');
                    paypalDestination.querySelector('input').required = false;
                    bankDestination.querySelector('textarea').required = true;
                }
            }
            
            // Update selected visual state
            document.querySelectorAll('input[name="withdrawalMethod"]').forEach(radio => {
                const label = radio.closest('label');
                if (radio.checked) {
                    label.classList.add('border-red-500', 'bg-red-50');
                    label.classList.remove('border-gray-200');
                } else {
                    label.classList.remove('border-red-500', 'bg-red-50');
                    label.classList.add('border-gray-200');
                }
            });
        }

        function loadUserData() {
            // Mock user data loading
            setTimeout(() => {
                if (currentMode === 'client') {
                    loadClientData();
                } else {
                    loadNodeData();
                }
            }, 1000);
        }
        
        // Initialize payment service when page loads
        document.addEventListener('DOMContentLoaded', () => {
            paymentService = new PaymentService();
            
            // Add event listeners for live updates
            document.addEventListener('input', (e) => {
                if (e.target.name === 'amount') {
                    updateDepositPreview();
                } else if (e.target.name === 'tokenAmount') {
                    updateWithdrawPreview();
                }
            });
            
            document.addEventListener('change', (e) => {
                if (e.target.name === 'currency' || e.target.name === 'paymentMethod') {
                    updateDepositPreview();
                } else if ((e.target.name === 'currency' && e.target.closest('form').querySelector('[name="tokenAmount"]')) || e.target.name === 'withdrawalMethod') {
                    updateWithdrawPreview();
                }
            });
        });
    </script>
</body>
</html>